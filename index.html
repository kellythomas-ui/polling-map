<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Polling Place Finder</title>
  <!-- Mapbox GL JS -->
  <link href="https://api.mapbox.com/mapbox-gl-js/v3.15.0/mapbox-gl.css" rel="stylesheet" />
  <script src="https://api.mapbox.com/mapbox-gl-js/v3.15.0/mapbox-gl.js"></script>
  <!-- Mapbox Geocoder -->
  <link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.1.0/mapbox-gl-geocoder.css" type="text/css" />
  <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.1.0/mapbox-gl-geocoder.min.js"></script>
  <!-- Turf.js for distance/nearest -->
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@7.2.0/turf.min.js"></script>
  <!-- Papa Parse for CSV loading -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    :root { --bg:#0b1020; --card:#11162a; --text:#f4f6fa; --muted:#9aa3b2; }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:15px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
    header{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid #1e2641;background:linear-gradient(180deg,#0d1430,#0b1020)}
    header h1{font-size:18px;margin:0;font-weight:650}
    #app{display:grid;grid-template-columns:380px 1fr;min-height:calc(100vh - 58px)}
    @media (max-width: 920px){#app{grid-template-columns:1fr;grid-template-rows:420px 1fr}}
    #sidebar{background:var(--card);border-right:1px solid #1e2641;padding:12px 12px 0;overflow:auto}
    .panel{background:#0e1530;border:1px solid #1e2641;border-radius:14px;padding:12px;margin-bottom:12px}
    .row{display:flex;gap:8px;align-items:center}
    .row.wrap{flex-wrap:wrap}
    label{font-size:13px;color:var(--muted)}
    input[type="text"]{width:100%;padding:10px;border-radius:10px;border:1px solid #243056;background:#0b132c;color:var(--text)}
    select,button{padding:9px 12px;border-radius:10px;border:1px solid #243056;background:#0b132c;color:var(--text);cursor:pointer}
    button.primary{background:#153a6b;border-color:#2a60a4}
    #app main{position:relative; min-height:calc(100vh - 58px);}
    #map{position:absolute; inset:0; width:100%; height:100%; min-height:400px;}
    .site{border-top:1px solid #1e2641;padding:10px 4px}
    .site:first-child{border-top:none}
    .site h3{margin:0 0 4px 0;font-size:15px}
    .muted{color:var(--muted)}
    .dist{font-variant-numeric:tabular-nums}
    .legend{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .dot{width:10px;height:10px;border-radius:50%}
    .dot.ev{background:#22c55e}
    .dot.ed{background:#3b82f6}
    .dot.both{background:#8b5cf6}
    .footer{font-size:12px;color:var(--muted);padding:10px 0}
    .list{max-height:52vh;overflow:auto}
    .kicker{font-size:12px;color:#7ea9ff}
    .btn-row{display:flex;gap:8px;flex-wrap:wrap}
    a.btn{display:inline-block;text-decoration:none}
    /* Popup styling (light popup) */
    .mapboxgl-popup.light-popup { background: #fff !important; color: #111 !important; }
    .mapboxgl-popup.light-popup .mapboxgl-popup-content { background:#fff !important; color:#111 !important; border-radius:8px; font-size:14px; line-height:1.4; border:1px solid #ccc; }
    .mapboxgl-popup.light-popup .mapboxgl-popup-close-button { color:#111 !important; }
    .mapboxgl-popup-tip { border-top-color:#fff !important; }
  </style>
</head>
<body>
<header>
  <h1>Find a place to vote</h1>
  <div class="legend">
    <span class="dot ev"></span><span class="muted">Early Voting</span>
    <span class="dot ed"></span><span class="muted">Election Day</span>
    <span class="dot both"></span><span class="muted">Both</span>
  </div>
</header>
<div id="app">
  <aside id="sidebar">
    <div class="panel">
      <div class="kicker">Step 1</div>
      <label for="addr">Enter your address</label>
      <div id="geocoder" class="mb-2" style="margin-top:6px"></div>
      <input id="addr" type="text" placeholder="Or type an address and press Locate" />
      <div class="btn-row" style="margin-top:8px">
        <button id="locate" class="primary">Locate</button>
        <button id="clear">Clear</button>
      </div>
    </div>

    <div class="panel">
      <div class="kicker">Step 2</div>
      <div class="row wrap" style="gap:6px 10px">
        <label><input type="checkbox" id="filter-ev" checked> Early Voting</label>
        <label><input type="checkbox" id="filter-ed" checked> Election Day</label>
      </div>
    </div>

    <div class="panel">
      <div class="row" style="justify-content:space-between">
        <strong>Nearest locations</strong>
        <span class="muted" id="count">0</span>
      </div>
      <div class="list" id="list"></div>
      <div class="footer">Locations change by election. Confirm before you go.</div>
    </div>
  </aside>
  <main><div id="map"></div></main>
</div>

<script>
// ===== CONFIG =====
const CONFIG = {
  MAPBOX_TOKEN: "pk.eyJ1Ijoia2VsbGF0aG9tYXMiLCJhIjoiY21nemtreGM5MHNuYzJqcTRwMzUwaWNrcCJ9.OJKWNpnTc_iFxD2ARuwJ5Q",
  DATA_URL: "sites.csv", // CSV file path in same folder
};

// ===== HELPERS: sanitize + column auto-detect + type normalization =====
const COALESCE_KEYS = {
  name: ["name","site_name","location","location_name","place","venue"],
  address: ["address","addr","street","street_address"],
  city: ["city","town"],
  zip: ["zip","zipcode","zip_code","postal"],
  lat: ["lat","latitude","y"],
  lng: ["lng","lon","long","longitude","x"],
  type: ["type","site_type","voting_type","mode"],
  hours: ["hours","open_hours","times"],
  hoursEv: ["hours_ev","ev_hours","early_hours","hours_early"],
  hoursEd: ["hours_ed","ed_hours","eday_hours","hours_election_day"],
  start: ["start_date","start","open_from"],
  end: ["end_date","end","open_to"],
  notes: ["notes","note","details","extra"]
};

function lowerKeys(obj){ const out = {}; for (const k in obj){ out[k.toLowerCase().trim()] = obj[k]; } return out; }
function get(row, keys){ for (const k of keys){ const v = row[k]; if (v !== undefined && v !== null && String(v).trim() !== '') return String(v).trim(); } return ''; }
function normalizeType(raw){
  const v = String(raw||'').toLowerCase();
  const hasEarly = /(^|\b)(early|ev)(\b|$)/.test(v);
  const hasEDay = /(election\s*day|eday|e\s*day|^ed$)/.test(v);
  if (hasEarly && hasEDay) return 'Both';
  if (hasEarly) return 'Early Voting';
  if (hasEDay) return 'Election Day';
  return 'Election Day';
}

function featureFromRow(r, id){
  const row = lowerKeys(r);
  const name = get(row, COALESCE_KEYS.name);
  const address = get(row, COALESCE_KEYS.address);
  const city = get(row, COALESCE_KEYS.city);
  const zip = get(row, COALESCE_KEYS.zip);
  const lat = parseFloat(get(row, COALESCE_KEYS.lat));
  const lng = parseFloat(get(row, COALESCE_KEYS.lng));
  const type = normalizeType(get(row, COALESCE_KEYS.type));
  const hoursGeneric = get(row, COALESCE_KEYS.hours);
  const hoursEv = get(row, COALESCE_KEYS.hoursEv);
  const hoursEd = get(row, COALESCE_KEYS.hoursEd);
  const start = get(row, COALESCE_KEYS.start);
  const end = get(row, COALESCE_KEYS.end);
  const notes = get(row, COALESCE_KEYS.notes);
  if (isNaN(lat) || isNaN(lng)) return null;
  return {
    type:'Feature',
    geometry:{ type:'Point', coordinates:[lng,lat] },
    properties:{ id, name, address, city, zip, type, hoursGeneric, hoursEv, hoursEd, start, end, notes }
  };
}

// ===== MAP INIT =====
mapboxgl.accessToken = CONFIG.MAPBOX_TOKEN;
const map = new mapboxgl.Map({ container:'map', style:'mapbox://styles/mapbox/streets-v12', center:[-98.5,29.4], zoom:8 });
map.addControl(new mapboxgl.NavigationControl(), 'top-right');

// Geocoder UI (Mapbox)
const geocoder = new MapboxGeocoder({ accessToken: mapboxgl.accessToken, mapboxgl, marker:false, placeholder:'123 Main St, City, TX' });
const geocoderEl = document.getElementById('geocoder');
geocoder.addTo(geocoderEl);

let sitesFC = { type: 'FeatureCollection', features: [] };
let voterPoint = null; // Turf point of voter address

// --- DOM Markers (reliable pins) ---
let domMarkers = [];
const markerById = new Map();

function popupHTMLForFeature(f){
  const p = f.properties || {};
  const name = p.name || 'Polling location';
  const line2 = [(p.address||''),(p.city||''),(p.zip||'')].filter(Boolean).join(', ').replace(/,\s*,/g, ', ');

  const hoursLines = [];
  const typeLower = (p.type || '').toLowerCase();
  if (typeLower === 'both'){
    if (p.hoursEv) hoursLines.push(`<div>Early Voting: ${p.hoursEv}</div>`);
    if (p.hoursEd) hoursLines.push(`<div>Election Day: ${p.hoursEd}</div>`);
    if (!hoursLines.length && p.hoursGeneric) hoursLines.push(`<div>Hours: ${p.hoursGeneric}</div>`);
  } else if (p.hours) {
    hoursLines.push(`<div>Hours: ${p.hours}</div>`);
  } else if (p.hoursGeneric) {
    hoursLines.push(`<div>Hours: ${p.hoursGeneric}</div>`);
  }

  const dist = voterPoint ? `<div class="dist" style="margin-top:6px">Distance: ${formatDist(distanceFromVoter(f))}</div>` : '';
  const notes = p.notes ? `<div class="muted" style="margin-top:4px">${p.notes}</div>` : '';
  const dest  = encodeURIComponent(line2);

  return `
    <strong>${name}</strong><br/>
    ${line2 || ''}<br/>
    <span class="muted">${p.type || ''}</span>
    ${hoursLines.length ? hoursLines.join('') : ''}
    ${notes}
    ${dist}
    <div style="margin-top:8px"><a class="btn" target="_blank" href="https://www.google.com/maps/dir/?api=1&destination=${dest}">Get Directions</a></div>
  `;
}

function clearMarkers(){
  domMarkers.forEach(m => m.remove());
  domMarkers = [];
  markerById.clear();
}
function renderMarkers(){
  const feats = filteredSites();
  clearMarkers();
  feats.forEach(f => {
    const t = f.properties.type;
    const color = (t === 'Early Voting') ? '#22c55e'
                : (t === 'Election Day') ? '#3b82f6'
                : /* Both */              '#8b5cf6';

    const popup = new mapboxgl.Popup({ offset: 12, className: 'light-popup' })
      .setHTML(popupHTMLForFeature(f));

    const marker = new mapboxgl.Marker({ color })
      .setLngLat(f.geometry.coordinates)
      .setPopup(popup)    // ← attach popup; opens on click automatically
      .addTo(map);

    domMarkers.push(marker);
    markerById.set(f.properties.id, marker);
  });
}

// Optional: keep a GeoJSON source around (not required for markers)
function initLayers(){
  if (!map.getSource('sites')) {
    map.addSource('sites', { type:'geojson', data: sitesFC });
  } else {
    map.getSource('sites').setData(sitesFC);
  }
}
if (map.loaded()) { initLayers(); } else { map.on('load', initLayers); }

// ===== DATA LOAD =====
Papa.parse(CONFIG.DATA_URL, {
  download:true, header:true, dynamicTyping:true, skipEmptyLines:true,
  delimiter:"", transformHeader: h => String(h||'').trim(),
  complete: (res) => {
    const feats = [];
    (res.data||[]).forEach((r,i)=>{
      const f = featureFromRow(r, i+1);
      if (!f) return;
      // Keep a single feature even if site serves both periods
      feats.push(f);
    });
    sitesFC.features = feats;

    if (map.getSource('sites')) map.getSource('sites').setData(sitesFC);
    renderMarkers();
    renderSites();
    fitToData();
  },
  error: (err) => console.error('CSV load error', err)
});

// ===== VIEW HELPERS =====
function fitToData(){
  if (!sitesFC.features.length) return;
  const b = turf.bbox(sitesFC);
  map.fitBounds(b, { padding: 40, maxZoom: 12 });
}

// ===== ADDRESS & FILTER UI =====
const addrInput = document.getElementById('addr');
document.getElementById('locate').onclick = ()=> locateAddress(addrInput.value);
document.getElementById('clear').onclick = ()=> {
  addrInput.value=''; voterPoint=null;
  if (map.getSource('voter')) { map.removeLayer('voter'); map.removeSource('voter'); }
  renderMarkers();
  renderSites();
};

geocoder.on('result', (ev)=>{ const { center, place_name } = ev.result; addrInput.value = place_name; setVoterPoint(center[0], center[1]); });
function locateAddress(text){ if (!text) return alert('Enter an address'); geocoder.query(text); }
function setVoterPoint(lng, lat){
  voterPoint = turf.point([lng, lat]);
  const geo = { type:'FeatureCollection', features:[{ type:'Feature', geometry:{ type:'Point', coordinates:[lng,lat] } }] };
  if (!map.getSource('voter')){
    map.addSource('voter',{ type:'geojson', data:geo });
    map.addLayer({ id:'voter', type:'circle', source:'voter',
      paint:{ 'circle-radius':8,'circle-color':'#ffd166','circle-stroke-color':'#0b1020','circle-stroke-width':1 } });
  } else {
    map.getSource('voter').setData(geo);
  }
  map.flyTo({ center:[lng,lat], zoom: 12 });
  renderMarkers();
  renderSites();
}

const evChk = document.getElementById('filter-ev');
const edChk = document.getElementById('filter-ed');
evChk.onchange = edChk.onchange = ()=> { renderMarkers(); renderSites(); };

function filteredSites(){
  const feats = sitesFC.features.slice();
  const wantEV = evChk.checked;
  const wantED = edChk.checked;
  if (!wantEV && !wantED) return [];
  return feats.filter(f => {
    const t = f.properties.type;
    if (t === 'Early Voting') return wantEV;
    if (t === 'Election Day') return wantED;
    if (t === 'Both') return (wantEV || wantED);
    return false;
  });
}
function distanceFromVoter(feature){ if (!voterPoint) return null; return turf.distance(voterPoint, feature, { units: 'miles' }); }
function formatDist(mi){ if (mi === null) return ''; return mi < 10 ? `${mi.toFixed(2)} mi` : `${mi.toFixed(1)} mi`; }

function renderSites(){
  const feats = filteredSites();
  const list = document.getElementById('list');

  // Sort by distance if we have an address
  let sorted = feats;
  if (voterPoint){ sorted = feats.slice().sort((a,b)=> distanceFromVoter(a) - distanceFromVoter(b)); }

  // De-duplicate by site id so “Both” shows only once
  const seen = new Set();
  sorted = sorted.filter(f => { const id = f.properties.id; if (seen.has(id)) return false; seen.add(id); return true; });

  // Update count
  document.getElementById('count').textContent = sorted.length;

  list.innerHTML = '';
  sorted.forEach(f => {
    const p = f.properties;
    const d = voterPoint ? formatDist(distanceFromVoter(f)) : '';
    const line2 = [(p.address||''),(p.city||''),(p.zip||'')].filter(Boolean).join(', ');

    const hoursBlock = (p.type === 'Both')
      ? `${p.hoursEv?`<div>Early Voting: ${p.hoursEv}</div>`:''}`
        + `${p.hoursEd?`<div>Election Day: ${p.hoursEd}</div>`:''}`
        + `${(!p.hoursEv && !p.hoursEd && p.hoursGeneric)?`<div>Hours: ${p.hoursGeneric}</div>`:''}`
      : `${p.hours?`<div>Hours: ${p.hours}</div>`: (p.hoursGeneric?`<div>Hours: ${p.hoursGeneric}</div>`:'')}`;

    const el = document.createElement('div');
    el.className = 'site';
    el.setAttribute('data-siteid', p.id);
    el.innerHTML = `
      <h3>${p.name || 'Polling location'}</h3>
      <div>${line2}</div>
      <div class="muted">${p.type}${d?` · <span class="dist">${d}</span>`:''}</div>
      ${hoursBlock}
      ${p.notes?`<div class="muted">${p.notes}</div>`:''}
      <div class="btn-row" style="margin-top:6px">
        <a class="btn" target="_blank" href="https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(line2)}">Directions</a>
        <button data-jump>Zoom</button>
      </div>
    `;
    el.querySelector('button[data-jump]').onclick = ()=> {
      map.flyTo({ center: f.geometry.coordinates, zoom: 14 });
      const m = markerById.get(p.id);
      if (m) m.togglePopup();
    };
    list.appendChild(el);
  });
}
</script>

<!--
CSV TIP:
- For sites with BOTH periods, keep one row, set type to "both" (or “early and e day”), and add:
  hours_ev, hours_ed
- For sites with a single period, either fill "hours" or the one appropriate hours_* column.
-->
</body>
</html>
